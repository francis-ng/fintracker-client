(this["webpackJsonpfinancial-tracker-client"]=this["webpackJsonpfinancial-tracker-client"]||[]).push([[0],{15:function(e,t,n){},22:function(e,t,n){},23:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),o=n(4),c=n.n(o),s=(n(13),n(14),n(15),n(1)),i=n(2);function u(e){return r.a.createElement(s.Toolbar,null,r.a.createElement("div",{className:"center"},e.title))}function l(e){return r.a.createElement(s.Toolbar,null,r.a.createElement("div",{className:"left"},e.showBackButton&&r.a.createElement(s.BackButton,null,"Back")),r.a.createElement("div",{className:"center"},e.title),r.a.createElement("div",{className:"right"},r.a.createElement(s.ToolbarButton,{onClick:e.buttonCallback},"Fixed items")))}function d(e){return r.a.createElement(s.Toolbar,null,r.a.createElement("div",{className:"left"},e.showBackButton&&r.a.createElement(s.BackButton,null,"Back")),r.a.createElement("div",{className:"center"},e.title),r.a.createElement("div",{className:"right"},r.a.createElement(s.ToolbarButton,null,r.a.createElement(s.Icon,{icon:"check",onClick:e.buttonCallback}))))}var m={getServerUrl:function(){return"https://fintrack-image-occpy2fuaa-an.a.run.app"},isReachable:function(){return fetch(this.getServerUrl(),{method:"HEAD",mode:"no-cors"}).then((function(e){return!0})).catch((function(e){return!1}))},login:function(e,t){var n=this.getServerUrl()+"/api/user/login";return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({UserName:e,Password:t})}).then((function(e){return e.ok?e.json().then((function(e){return{success:!0,token:e.token}})):{success:!1}}))},register:function(e,t){var n=this.getServerUrl()+"/api/user/register";return fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({UserName:e,Password:t})}).then((function(e){return e.ok?{success:!0}:{success:!1}}))}};var f={getToken:function(){return localStorage.getItem("authToken")},saveToken:function(e){localStorage.setItem("authToken",e)}},g=function(e){var t=Object(a.useState)(!0),n=Object(i.a)(t,2),o=n[0],c=n[1],l=Object(a.useState)(!1),d=Object(i.a)(l,2),g=d[0],h=d[1],p=Object(a.useState)(!1),v=Object(i.a)(p,2),b=v[0],E=v[1],k=Object(a.useState)(!1),w=Object(i.a)(k,2),y=w[0],T=w[1],O=Object(a.useState)(!1),C=Object(i.a)(O,2),j=C[0],S=C[1],L=Object(a.useState)(!1),N=Object(i.a)(L,2),I=N[0],U=N[1],B=Object(a.useState)(!1),D=Object(i.a)(B,2),A=D[0],P=D[1],x=Object(a.useState)(""),z=Object(i.a)(x,2),q=z[0],M=z[1],R=Object(a.useState)(""),Y=Object(i.a)(R,2),J=Y[0],W=Y[1],H=Object(a.useState)(""),F=Object(i.a)(H,2),G=F[0],V=F[1],$=Object(a.useState)(""),K=Object(i.a)($,2),Q=K[0],X=K[1],Z=Object(a.useState)(""),_=Object(i.a)(Z,2),ee=_[0],te=_[1],ne=function(){T(!1),S(!1),U(!1),P(!1)};return r.a.createElement(s.Page,{renderToolbar:function(){return r.a.createElement(u,{title:"Login"})}},b&&r.a.createElement(s.ProgressBar,{indeterminate:!0}),r.a.createElement("div",null,o&&r.a.createElement("form",{onSubmit:function(t){t.preventDefault(),E(!0),m.login(q,J).then((function(t){E(!1),t.success?(f.saveToken(t.token),ne(),e.navigator.popPage()):(ne(),U(!0))}))}},r.a.createElement("div",{className:"center"},r.a.createElement(s.Toast,{isOpen:y},r.a.createElement("div",{className:"message"},"Registration successful"),r.a.createElement("button",{onClick:ne},"Dismiss")),r.a.createElement(s.Toast,{isOpen:I},r.a.createElement("div",{className:"message"},"The username and password do not match"),r.a.createElement("button",{onClick:ne},"Dismiss")),r.a.createElement(s.Input,{value:q,onChange:function(e){return M(e.target.value)},placeholder:"User name",required:!0}),r.a.createElement(s.Input,{type:"password",value:J,onChange:function(e){return W(e.target.value)},placeholder:"Password",required:!0}),r.a.createElement(s.Button,{type:"submit"},"Login"),r.a.createElement(s.Button,{onClick:function(){c(!1),h(!0),T(!1),S(!1),U(!1)},modifier:"quiet"},"Click here to register"))),g&&r.a.createElement("form",{onSubmit:function(e){e.preventDefault(),ee===Q?(E(!0),m.register(q,J).then((function(e){E(!1),e.success?(ne(),c(!0),T(!0)):S(!0)}))):P(!0)}},r.a.createElement("div",{className:"center"},r.a.createElement(s.Toast,{isOpen:j},r.a.createElement("div",{className:"message"},"Registration failed"),r.a.createElement("button",{onClick:ne},"Dismiss")),r.a.createElement(s.Toast,{isOpen:A},r.a.createElement("div",{className:"message"},"The passwords do not match."),r.a.createElement("button",{onClick:ne},"Dismiss")),r.a.createElement(s.Input,{value:G,onChange:function(e){return V(e.target.value)},placeholder:"User name",required:!0}),r.a.createElement(s.Input,{type:"password",value:Q,onChange:function(e){return X(e.target.value)},placeholder:"Password",required:!0}),r.a.createElement(s.Input,{type:"password",value:ee,onChange:function(e){return te(e.target.value)},placeholder:"Verify password",required:!0}),r.a.createElement(s.Button,{type:"submit"},"Register"),r.a.createElement(s.Button,{onClick:function(){c(!0),h(!1),T(!1),S(!1),U(!1)},modifier:"quiet"},"Return to login")))))};var h,p={getServerUrl:function(){return"https://fintrack-image-occpy2fuaa-an.a.run.app"},listLedgers:function(e){var t=this.getServerUrl()+"/api/ledger/list",n=new Headers({Authorization:"Bearer "+e});return fetch(t,{headers:n}).then((function(e){return e.ok?e.json().then((function(e){return{success:!0,data:e}})):404===e.status?{success:!1,status:"Not found"}:401===e.status||403===e.status?{success:!1,status:"Unauthorized"}:{success:!1,status:"Error",data:[]}}))},getLedger:function(e,t,n){var a=this.getServerUrl()+"/api/ledger/get?year="+t+"&month="+n,r=new Headers({Authorization:"Bearer "+e});return fetch(a,{headers:r}).then((function(e){return e.ok?e.json().then((function(e){return{success:!0,data:e}})):401===e.status||403===e.status?{success:!1,status:"Unauthorized"}:404===e.status?{success:!1,status:"Not found"}:{success:!1,status:"Error",data:{Id:"",Owner:"",Type:"",Month:"",Year:"",Debits:[],DebitTotal:"",Credits:[],CreditTotal:""}}}))},addLedger:function(e,t){var n=this.getServerUrl()+"/api/ledger/add",a=new Headers({Authorization:"Bearer "+e,"Content-Type":"application/json"});return fetch(n,{method:"POST",headers:a,body:JSON.stringify(t)}).then((function(e){return e.ok?{success:!0}:401===e.status||403===e.status?{success:!1,status:"Unauthorized"}:{success:!1,status:"Error"}}))},updateLedger:function(e,t){var n=this.getServerUrl()+"/api/ledger/update?id="+t.Id,a=new Headers({Authorization:"Bearer "+e,"Content-Type":"application/json"});return fetch(n,{method:"PUT",headers:a,body:JSON.stringify(t)}).then((function(e){return e.ok?{success:!0}:401===e.status||403===e.status?{success:!1,status:"Unauthorized"}:{success:!1,status:"Error"}}))},deleteLedger:function(e,t){var n=this.getServerUrl()+"/api/ledger/delete?id="+t.Id,a=new Headers({Authorization:"Bearer "+e,"Content-Type":"application/json"});return fetch(n,{method:"DELETE",headers:a}).then((function(e){return e.ok?{success:!0}:401===e.status||403===e.status?{success:!1,status:"Unauthorized"}:{success:!1,status:"Error"}}))}},v=n(3),b=function(e){var t={year:e.selection.year,month:e.selection.month,type:0===e.selection.year?"fixed":"regular"},n=Object(a.useState)(!1),o=Object(i.a)(n,2),c=o[0],u=o[1],l=Object(a.useState)(!1),m=Object(i.a)(l,2),h=m[0],b=m[1],E=Object(a.useState)(!1),k=Object(i.a)(E,2),w=k[0],y=k[1],T=Object(a.useState)({Type:t.type,Month:t.month,Year:t.year,Debits:[],DebitTotal:"",Credits:[],CreditTotal:""}),O=Object(i.a)(T,2),C=O[0],j=O[1],S=Object(a.useRef)(!1);Object(a.useEffect)((function(){console.log("Loading ".concat(t.year,"/").concat(t.month));p.getLedger(f.getToken(),t.year,t.month).then((function(t){y(!0),t.success?j(t.data):"Not found"===t.status?(console.log("No data found. New ledger will be created"),S.current=!0,"regular"===(void 0).state.ledger.Type&&(console.log("Loading fixed items"),y(!1),p.getLedger(f.getToken(),0,0).then((function(t){if(y(!0),t.success){var n=Object(v.a)({},C);n.Debits.concat({Label:"Fixed expenses",Amount:t.data.DebitTotal}),n.Credits.concat({Label:"Fixed income",Amount:t.data.CreditTotal}),n.DebitTotal=t.data.DebitTotal,n.CreditTotal=t.data.CreditTotal,j(n)}else"Unauthorized"===t.status&&e.navigator.pushPage({component:g})})))):"Unauthorized"===t.status&&e.navigator.pushPage({component:g})}))}),[]);var L=function(e,t){return t.Amount?e+parseInt(t.Amount):e},N=function(e){var t=e.target.value,n=e.target.name,a=e.target.dataset.page,r=parseInt(e.target.dataset.index);console.log("Updating ".concat(n," of item ").concat(r," of ").concat(a));var o=Object(v.a)({},C);o[a][r][n]=t,o.DebitTotal=o.DebitTotal.reduce(L,0),o.CreditTotal=o.CreditTotal.reduce(L,0),j(o)},I=function(){console.log("Adding new expense");var e=Object(v.a)({},C);e.Debits.concat({Label:"",Amount:""}),j(e)},U=function(){console.log("Adding new income");var e=Object(v.a)({},C);e.Credits.concat({Label:"",Amount:""}),j(e)},B=function(e,t){return r.a.createElement(s.ListItem,null,r.a.createElement("div",{className:"left"},r.a.createElement(s.Input,{name:"Label","data-index":t,"data-page":"Debits",value:C.Debits[t].Label,onChange:N,placeholder:"Item"})),r.a.createElement("div",{className:"right"},r.a.createElement(s.Input,{name:"Amount","data-index":t,"data-page":"Debits",value:C.Debits[t].Amount,onChange:N,placeholder:"Amount"})))},D=function(e,t){return r.a.createElement(s.ListItem,null,r.a.createElement("div",{className:"left"},r.a.createElement(s.Input,{name:"Label","data-index":t,"data-page":"Credits",value:C.Credits[t].Label,onChange:N,placeholder:"Item"})),r.a.createElement("div",{className:"right"},r.a.createElement(s.Input,{name:"Amount","data-index":t,"data-page":"Credits",value:C.Credits[t].Amount,onChange:N,placeholder:"Amount"})))},A=function(e){return r.a.createElement(s.Page,null,r.a.createElement(s.List,{dataSource:C.Debits,renderRow:B}),r.a.createElement(s.Button,{modifier:"large quiet"},r.a.createElement(s.Icon,{size:{default:16},icon:{default:"plus"},onClick:I}),"\xa0 New item"))},P=function(e){return r.a.createElement(s.Page,null,r.a.createElement(s.List,{dataSource:C.Credits,renderRow:D}),r.a.createElement(s.Button,{modifier:"large quiet"},r.a.createElement(s.Icon,{size:{default:16},icon:{default:"plus"},onClick:U}),"\xa0 New item"))},x=function(){u(!1),b(!1),S.current?p.addLedger(f.getToken(),C).then((function(e){e.success?u(!0):b(!0)})):p.updateLedger(f.getToken(),C).then((function(e){e.success?u(!0):b(!0)}))},z=function(){u(!1),b(!1)};return r.a.createElement(s.Page,{renderToolbar:function(){return r.a.createElement(d,{showBackButton:!0,title:"Edit details",buttonCallback:x})},renderBottomToolbar:function(){return r.a.createElement(s.BottomToolbar,null,r.a.createElement("div",{style:{padding:"16px"}},r.a.createElement("div",{style:{textAlign:"left",width:"50%",display:"inline-block"}},"Nett"),r.a.createElement("div",{style:{textAlign:"right",width:"50%",display:"inline-block"}},C.CreditTotal-C.DebitTotal)))}},!w&&r.a.createElement(s.ProgressBar,{indeterminate:!0}),r.a.createElement(s.Toast,{isOpen:c},r.a.createElement("div",{className:"message"},"Saved successfully."),r.a.createElement("button",{onClick:z},"Dismiss")),r.a.createElement(s.Toast,{isOpen:h},r.a.createElement("div",{className:"message"},"Saving failed. Please try again."),r.a.createElement("button",{onClick:z},"Dismiss")),r.a.createElement(s.Tabbar,{swipeable:!0,position:"auto",renderTabs:function(){return[{content:r.a.createElement(A,null),tab:r.a.createElement(s.Tab,{label:"Expenses",icon:""})},{content:r.a.createElement(P,null),tab:r.a.createElement(s.Tab,{label:"Income",icon:""})}]}}))},E=function(e){var t=["","January","February","March","April","May","June","July","August","September","October","November","December"],n=Object(a.useState)("Pull to refresh"),o=Object(i.a)(n,2),c=o[0],u=o[1],d=Object(a.useState)(!1),m=Object(i.a)(d,2),h=m[0],v=m[1],E=Object(a.useState)([]),k=Object(i.a)(E,2),w=k[0],y=k[1],T=function(e,t){return e.Year!==t.Year?t.Year-e.Year:t.Month-e.Month},O=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;v(!1),p.listLedgers(f.getToken()).then((function(n){if(v(!0),n.success){var a=n.data.filter((function(e){return"regular"===e.Type}));a.sort(T),y(a)}else"Unauthorized"===n.status&&e.navigator.pushPage({component:g});t&&t()}))};Object(a.useEffect)((function(){O()}),[O]);var C=function(t){var n=parseInt(t.target.dataset.year),a=parseInt(t.target.dataset.month);e.navigator.pushPage({component:b,props:{selection:{year:n,month:a}}})},j=function(){e.navigator.pushPage({component:b,props:{selection:{year:0,month:0}}})};return r.a.createElement(s.Page,{renderToolbar:function(){return r.a.createElement(l,{showBackButton:!1,title:"Ledgers",buttonCallback:j})}},!h&&r.a.createElement(s.ProgressBar,{indeterminate:!0}),r.a.createElement(s.PullHook,{onChange:function(e){switch(e.state){case"initial":u("Pull to refresh");break;case"preaction":u("Release");break;case"action":u("Loading...")}},onLoad:O},c),r.a.createElement(s.List,{dataSource:w,renderRow:function(e,n){return r.a.createElement(s.ListItem,{tappable:!0,modifier:"chevron","data-year":w[n].Year,"data-month":w[n].Month,onClick:C},r.a.createElement("div",{className:"center"},"".concat(w[n].Year," ").concat(t[w[n].Month])))}}),r.a.createElement(s.Button,{modifier:"large quiet"},r.a.createElement(s.Icon,{size:{default:16},icon:{default:"plus"},onClick:function(){var t=new Date,n=t.getFullYear(),a=t.getMonth()+1;w.length>0&&(n=parseInt(w[0].Year),a=parseInt(w[0].Month),13===++a&&(n++,a=1)),e.navigator.pushPage({component:b,props:{selection:{year:n,month:a}}})}}),"\xa0 New item"))},k=(n(22),function(){return r.a.createElement(s.Navigator,{swipeable:!0,initialRoute:{component:E},renderPage:function(e,t){var n=e.props||{};return n.navigator=t,r.a.createElement(e.component,n)}})}),w=window.indexedDB.open("FinTrackDB",1);w.onsuccess=function(e){h=e.target.result},w.onerror=function(e){console.log("Unable to use IndexedDB")},w.onupgradeneeded=function(e){var t=(h=e.target.result).createObjectStore("ledgers",{autoIncrement:!0});t.createIndex("Id","Id",{unique:!1}),t.createIndex("Year","Year",{unique:!1}),t.createIndex("Month","Month",{unique:!1})};var y=p.getServerUrl(),T=!0;function O(){navigator.onLine?m.isReachable(y).then((function(e){e?(console.log("Client online"),T=!0):(console.log("No connectivity"),T=!1)})):(console.log("Client offline"),T=!1)}window.addEventListener("online",O),window.addEventListener("offline",O);var C=f.getToken();setInterval((function(){if(T){h.transaction("ledgers").objectStore("ledgers").openCursor().onsuccess=function(e){var t,n=e.target.result;n&&(console.log("Syncing entry "+n.value.key),(t=n.value,void p.getLedger(C,t.Year,t.Month).then((function(e){if(e.success){var n=Date.parse(e.data.UpdatedAt);return!(Date.parse(t.UpdatedAt)>n)||function(e){p.updateLedger(C,e).then((function(e){return!!e.success||("Unauthorized"===e.status&&postMessage("Unauthorized"),!1)}))}(t).then((function(e){return e}))}return"Unauthorized"===e.status?(postMessage("Unauthorized"),!1):"Not found"===e.status?function(e){p.addLedger(C,e).then((function(e){return!!e.success||("Unauthorized"===e.status&&postMessage("Unauthorized"),!1)}))}(t).then((function(e){return e})):void 0}))).then((function(e){e&&(console.log("Entry "+n.value.key+" synced"),console.log("Deleting entry "+n.value.key),h.transaction("ledgers","readwrite").objectStore("ledgers").delete(n.value.key).onsuccess=function(){return!0})})).then((function(e){console.log("Delete complete"),n.continue()})).catch((function(){console.log("Syncing failed for entry "+n.value.key),n.continue()})))}}}),1e4);var j={onmessage:function(e){h.transaction(["ledgers"],"readwrite").objectStore("ledgers").add(e.data)}},S=[""];j.onmessage=function(e){e.data},window.addEventListener("install",(function(e){console.log("[Service worker] Install"),e.waitUntil(caches.open("fintrackCache-v1").then((function(e){return console.log("[Service worker] Caching app shell"),e.addAll(S)})))})),window.addEventListener("fetch",(function(e){e.respondWith(fetch(e.request).then((function(t){return caches.open("fintrackCache-v1").then((function(n){return console.log("[Service Worker] Caching new resource: "+e.request.url),n.put(e.request,t.clone()),t}))})).catch((function(){"GET"==e.request.method?caches.match(e.request).then((function(e){return e})).catch((function(){return new Response(JSON.stringify({error:"No network connection"}))})):e.request.json().then((function(e){j.postMessage(e)}))})))})),window.addEventListener("activate",(function(e){e.waitUntil(caches.keys().then((function(e){return Promise.all(e.map((function(e){if("fintrackCache-v1"!==e)return caches.delete(e)})))})))}));var L=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function N(e,t){navigator.serviceWorker.register(e).then((function(e){e.onupdatefound=function(){var n=e.installing;null!=n&&(n.onstatechange=function(){"installed"===n.state&&(navigator.serviceWorker.controller?(console.log("New content is available and will be used when all tabs for this page are closed. See https://bit.ly/CRA-PWA."),t&&t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t&&t.onSuccess&&t.onSuccess(e)))})}})).catch((function(e){console.error("Error during service worker registration:",e)}))}c.a.render(r.a.createElement(k,null),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("/fintracker-client",window.location.href).origin!==window.location.origin)return;window.addEventListener("load",(function(){var t="".concat("/fintracker-client","/js/workers/service-worker.js");L?(!function(e,t){fetch(e,{headers:{"Service-Worker":"script"}}).then((function(n){var a=n.headers.get("content-type");404===n.status||null!=a&&-1===a.indexOf("javascript")?navigator.serviceWorker.ready.then((function(e){e.unregister().then((function(){window.location.reload()}))})):N(e,t)})).catch((function(){console.log("No internet connection found. App is running in offline mode.")}))}(t,e),navigator.serviceWorker.ready.then((function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://bit.ly/CRA-PWA")}))):N(t,e)}))}}()},8:function(e,t,n){e.exports=n(23)}},[[8,1,2]]]);
//# sourceMappingURL=main.d4213e34.chunk.js.map